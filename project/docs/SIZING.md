# Оценка ёмкости и масштабирование

Скрипт:
- `project/scripts/capacity_estimate.sh`

Назначение:
- быстро оценить безопасный диапазон пользователей на текущей VM;
- понять, когда нужно добавлять реплику или увеличивать ресурсы.

## Что считает скрипт
- ресурсы узла: CPU, load, RAM, disk, сеть;
- пользователей:
  - `active`
  - `grace`
  - `suspended`
  - `xray_current` (сколько клиентов сейчас в `xray config`)
- расчётную рекомендацию:
  - `Theoretical ... recommended` (верхняя оценка)
  - `Practical ... recommended` (рабочий прод-ориентир)
  - `Headroom (practical)`
  - `Status` (`OK`, `WARN`, `CRITICAL`)

## Запуск
```bash
cd /opt/vpn_vds
bash project/scripts/capacity_estimate.sh
```

Опции через env:
```bash
# grace-дни для расчета active+grace
GRACE_DAYS=1 bash project/scripts/capacity_estimate.sh

# длительность измерения сетевого rx/tx
SAMPLE_SEC=3 bash project/scripts/capacity_estimate.sh
```

## Интерпретация
- `OK`:
  - запас по `practical`-модели нормальный, можно выдавать новых пользователей в штатном режиме.
- `WARN`:
  - запас небольшой, лучше планировать новую реплику заранее.
- `CRITICAL`:
  - текущая ёмкость исчерпана или близко к этому.
  - ограничить новые выдачи, добавлять реплику/ресурсы.

## Практические пороги (дополнительно)
Даже если модель показывает `OK`, считать узел близким к пределу, если длительно наблюдается одно из условий:
- `load1 / vCPU > 0.9`
- RAM usage `> 85%`
- Disk usage `> 85%`
- заметный рост restart count у `hexenvpn-xray` или `hexenvpn-bot`

## Важно
- Это эвристика, а не синтетический нагрузочный тест.
- Для точного лимита на конкретном железе используйте постепенный рост реальной нагрузки и фиксируйте метрики по неделям.
